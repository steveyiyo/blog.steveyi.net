<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Building an Internal Network with WireGuard | SteveYi's Blog</title><meta name=keywords content="VPS,server"><meta name=description content="Hi everyone, today I&rsquo;m going to share how to use WireGuard to build an internal network.
Previously, I shared how to install WireGuard on Linux systems. This time, we will use WireGuard to build an internal network.
Why Build an Internal Network? Why does the author call this an &ldquo;internal network&rdquo;? Because the author may be in different places and wants to use this opportunity to add them all to the same LAN."><meta name=author content="SteveYi"><link rel=canonical href=https://blog.steveyi.net/en/posts/using-wireguard-to-make-intranet/><link crossorigin=anonymous href=/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.steveyi.net/images/me.png><link rel=icon type=image/png sizes=16x16 href=https://blog.steveyi.net/images/me.png><link rel=icon type=image/png sizes=32x32 href=https://blog.steveyi.net/images/me.png><link rel=apple-touch-icon href=https://blog.steveyi.net/images/me.png><link rel=mask-icon href=https://blog.steveyi.net/images/me.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.steveyi.net/en/posts/using-wireguard-to-make-intranet/><link rel=alternate hreflang=tw href=https://blog.steveyi.net/posts/using-wireguard-to-make-intranet/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-CPGWT2M3VT"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CPGWT2M3VT",{anonymize_ip:!1})}</script><meta property="og:title" content="Building an Internal Network with WireGuard"><meta property="og:description" content="Hi everyone, today I&rsquo;m going to share how to use WireGuard to build an internal network.
Previously, I shared how to install WireGuard on Linux systems. This time, we will use WireGuard to build an internal network.
Why Build an Internal Network? Why does the author call this an &ldquo;internal network&rdquo;? Because the author may be in different places and wants to use this opportunity to add them all to the same LAN."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.steveyi.net/en/posts/using-wireguard-to-make-intranet/"><meta property="og:image" content="https://blog.steveyi.net/images/banner.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-11-20T18:31:04+00:00"><meta property="article:modified_time" content="2020-11-20T18:31:04+00:00"><meta property="og:site_name" content="SteveYi's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.steveyi.net/images/banner.webp"><meta name=twitter:title content="Building an Internal Network with WireGuard"><meta name=twitter:description content="Hi everyone, today I&rsquo;m going to share how to use WireGuard to build an internal network.
Previously, I shared how to install WireGuard on Linux systems. This time, we will use WireGuard to build an internal network.
Why Build an Internal Network? Why does the author call this an &ldquo;internal network&rdquo;? Because the author may be in different places and wants to use this opportunity to add them all to the same LAN."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.steveyi.net/en/posts/"},{"@type":"ListItem","position":2,"name":"Building an Internal Network with WireGuard","item":"https://blog.steveyi.net/en/posts/using-wireguard-to-make-intranet/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Building an Internal Network with WireGuard","name":"Building an Internal Network with WireGuard","description":"Hi everyone, today I\u0026rsquo;m going to share how to use WireGuard to build an internal network.\nPreviously, I shared how to install WireGuard on Linux systems. This time, we will use WireGuard to build an internal network.\nWhy Build an Internal Network? Why does the author call this an \u0026ldquo;internal network\u0026rdquo;? Because the author may be in different places and wants to use this opportunity to add them all to the same LAN.","keywords":["VPS","server"],"articleBody":"Hi everyone, today I’m going to share how to use WireGuard to build an internal network.\nPreviously, I shared how to install WireGuard on Linux systems. This time, we will use WireGuard to build an internal network.\nWhy Build an Internal Network? Why does the author call this an “internal network”? Because the author may be in different places and wants to use this opportunity to add them all to the same LAN.\nThis can also solve some connection problems, such as the author often connecting back to the computer at home. But because there are only a few public IP addresses, when there are too many machines, internal network penetration needs to be set up.\nBut after the author set up the internal network, they only need to connect to the VPN outside, and in other network areas, they can access all network devices (which is similar to remote access in general enterprises).\nScenario and Architecture So, as before, we need a main server as the gateway. However, we do not use NAT TO NAT, but instead let Private directly connect with each other.\nOur scenario is like this:\nOffice A Router 10.121.208.254/24 Office B Router 10.121.209.254/24 Office C Router 10.121.210.254/24 VPN Router 10.121.211.254/24 Configuring VPN Tunnel and Static Routing First of all, since we are purely setting up an internal network this time, WireGuard with static routing is the main focus. So we won’t talk about routing protocols. If you are interested, you can also refer to my article Building Different Network Segments Communication Through BGP.\nWe need a main router and connect the routers in offices A, B, and C through it.\nSo it becomes like this:\nVPN \u003c-\u003e A VPN \u003c-\u003e B VPN \u003c-\u003e C When a user from A wants to go to C (10.121.208.1 \u003c-\u003e 10.121.210.2), the route becomes…\nUser-A -\u003e 10.121.208.254 -\u003e 10.121.211.254 -\u003e 10.121.210.254 -\u003e User-C\nThat is, User-A -\u003e A’s router -\u003e VPN gateway -\u003e C’s router -\u003e User-C\nNow that we understand the principle, let’s implement it!\nFirst, I prepare the private key and public key (the public key is calculated from the private key).\nA's Public key: WGokwN2HtiX+naa7hdvUaXoXk5tkzXQtMge4v9DKlVw= B's Public key: fVNXw6EpC65DmIsY/XsWXL6EXLU9oFW7CL5cZr82Di8= C's Public key: ORbEFZlR/IWFWaD42Nh00DfYEpCX2CbNmRy/Hc+crVQ= VPN's Public Key: Rxcti9/3jLII4JOscHn9/yp5Z8ZROcYk8tugXn/FRHM= So we write it in the configuration like this…\n[Interface] PrivateKey = Address = ","wordCount":"527","inLanguage":"en","datePublished":"2020-11-20T18:31:04Z","dateModified":"2020-11-20T18:31:04Z","author":{"@type":"Person","name":"SteveYi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.steveyi.net/en/posts/using-wireguard-to-make-intranet/"},"publisher":{"@type":"Organization","name":"SteveYi's Blog","logo":{"@type":"ImageObject","url":"https://blog.steveyi.net/images/me.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.steveyi.net/en/ accesskey=h title="SteveYi's Blog (Alt + H)">SteveYi's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.steveyi.net/ title=正體中文 aria-label=正體中文>Tw</a></li></ul></div></div><ul id=menu><li><a href=https://blog.steveyi.net/en/ title="Home Page"><span>Home Page</span></a></li><li><a href=https://blog.steveyi.net/en/posts/ title=Articles><span>Articles</span></a></li><li><a href=https://steveyi.net/ title=About><span>About</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://x.com/steveyiyo title="X (Twitter)"><span>X (Twitter)</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Building an Internal Network with WireGuard</h1><div class=post-meta><span title='2020-11-20 18:31:04 +0000 UTC'>November 20, 2020</span>&nbsp;·&nbsp;SteveYi&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://blog.steveyi.net/posts/using-wireguard-to-make-intranet/>Tw</a></li></ul></div></header><div class=post-content><p>Hi everyone, today I&rsquo;m going to share how to use WireGuard to build an internal network.</p><p>Previously, I shared <a href=https://blog.steveyi.net/how-to-install-wireguard/>how to install WireGuard on Linux systems</a>. This time, we will use WireGuard to build an internal network.</p><h2 id=why-build-an-internal-network>Why Build an Internal Network?<a hidden class=anchor aria-hidden=true href=#why-build-an-internal-network>#</a></h2><p>Why does the author call this an &ldquo;internal network&rdquo;? Because the author may be in different places and wants to use this opportunity to add them all to the same LAN.</p><p>This can also solve some connection problems, such as the author often connecting back to the computer at home. But because there are only a few public IP addresses, when there are too many machines, internal network penetration needs to be set up.</p><p>But after the author set up the internal network, they only need to connect to the VPN outside, and in other network areas, they can access all network devices (which is similar to remote access in general enterprises).</p><h2 id=scenario-and-architecture>Scenario and Architecture<a hidden class=anchor aria-hidden=true href=#scenario-and-architecture>#</a></h2><p>So, as before, we need a main server as the gateway. However, we do not use NAT TO NAT, but instead let Private directly connect with each other.</p><p>Our scenario is like this:</p><ul><li>Office A Router 10.121.208.254/24</li><li>Office B Router 10.121.209.254/24</li><li>Office C Router 10.121.210.254/24</li><li>VPN Router 10.121.211.254/24</li></ul><h2 id=configuring-vpn-tunnel-and-static-routing>Configuring VPN Tunnel and Static Routing<a hidden class=anchor aria-hidden=true href=#configuring-vpn-tunnel-and-static-routing>#</a></h2><p>First of all, since we are purely setting up an internal network this time, WireGuard with static routing is the main focus. So we won&rsquo;t talk about routing protocols. If you are interested, you can also refer to my article <a href=https://blog.steveyi.net/posts/bgp-network-peer/>Building Different Network Segments Communication Through BGP</a>.</p><p>We need a main router and connect the routers in offices A, B, and C through it.</p><p>So it becomes like this:</p><pre tabindex=0><code>VPN &lt;-&gt; A  
VPN &lt;-&gt; B  
VPN &lt;-&gt; C
</code></pre><p>When a user from A wants to go to C (10.121.208.1 &lt;-> 10.121.210.2), the route becomes&mldr;</p><p>User-A -> 10.121.208.254 -> 10.121.211.254 -> 10.121.210.254 -> User-C</p><p>That is, User-A -> A&rsquo;s router -> VPN gateway -> C&rsquo;s router -> User-C</p><p>Now that we understand the principle, let&rsquo;s implement it!</p><p>First, I prepare the private key and public key (the public key is calculated from the private key).</p><pre tabindex=0><code>A&#39;s Public key: WGokwN2HtiX+naa7hdvUaXoXk5tkzXQtMge4v9DKlVw=  
B&#39;s Public key: fVNXw6EpC65DmIsY/XsWXL6EXLU9oFW7CL5cZr82Di8=  
C&#39;s Public key: ORbEFZlR/IWFWaD42Nh00DfYEpCX2CbNmRy/Hc+crVQ=  
VPN&#39;s Public Key: Rxcti9/3jLII4JOscHn9/yp5Z8ZROcYk8tugXn/FRHM=
</code></pre><p>So we write it in the configuration like this&mldr;</p><pre tabindex=0><code>[Interface]
PrivateKey = &lt;Private Key of each place&gt;
Address = &lt;IP of each router, for example, A&#39;s router 10.121.208.254/24&gt;

[Peer]
PublicKey = &lt;VPN Gateway Public Key&gt;
Endpoint = &lt;VPN Gateway&#39;s EndPoint&gt;
AllowedIPs = 10.121.209.0/24,10.121.210.0/24,10.121.211.0/24
PersistentKeepalive = 10
</code></pre><p>We configure it like this on each node, the above example is for A&rsquo;s router, and B&rsquo;s router is like this:</p><pre tabindex=0><code>[Interface]
PrivateKey = &lt;Private Key of each place&gt;
Address = &lt;IP of each router, for example, B&#39;s router 10.121.209.254/24&gt;

[Peer]
PublicKey = &lt;VPN Gateway Public Key&gt;
Endpoint = &lt;VPN Gateway&#39;s EndPoint&gt;
AllowedIPs = 10.121.208.0/24,10.121.210.0/24,10.121.211.0/24
PersistentKeepalive = 10
</code></pre><p>I believe everyone should be able to configure C&rsquo;s router.</p><p>Finally, all you need to do is execute the command <code>wg-quick up &lt;wireguard_interface_name></code> on each router to communicate with each other!</p><p>Special note: If the VPN gateway fails in this network architecture, then A, B, and C cannot communicate with each other.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.steveyi.net/en/tags/vps/>VPS</a></li><li><a href=https://blog.steveyi.net/en/tags/server/>server</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.steveyi.net/en/>SteveYi's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>