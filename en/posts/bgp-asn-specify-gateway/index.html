<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Designating network egress by AS Number | SteveYi's Blog</title><meta name=keywords content><meta name=description content="In January of last year, I applied for my first ASN - AS209557, and did a lot of cool experiments!
Today, I reconfigured my home router and can now designate which route to take based on ASN.
First, let me introduce my router information Ubuntu 20.04 software router
Bird2 (Internet Routing Daemon)
Network environment (including VPN tunnel) Chunghwa Telecom PPPoe non-fixed IP 100/40M
To TANet&rsquo;s WireGuard Tunnel
To GCP&rsquo;s WireGuard Tunnel"><meta name=author content="SteveYi"><link rel=canonical href=https://blog.steveyi.net/en/posts/bgp-asn-specify-gateway/><link crossorigin=anonymous href=/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.steveyi.net/images/me.png><link rel=icon type=image/png sizes=16x16 href=https://blog.steveyi.net/images/me.png><link rel=icon type=image/png sizes=32x32 href=https://blog.steveyi.net/images/me.png><link rel=apple-touch-icon href=https://blog.steveyi.net/images/me.png><link rel=mask-icon href=https://blog.steveyi.net/images/me.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.steveyi.net/en/posts/bgp-asn-specify-gateway/><link rel=alternate hreflang=tw href=https://blog.steveyi.net/posts/bgp-asn-specify-gateway/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-CPGWT2M3VT"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CPGWT2M3VT",{anonymize_ip:!1})}</script><meta property="og:title" content="Designating network egress by AS Number"><meta property="og:description" content="In January of last year, I applied for my first ASN - AS209557, and did a lot of cool experiments!
Today, I reconfigured my home router and can now designate which route to take based on ASN.
First, let me introduce my router information Ubuntu 20.04 software router
Bird2 (Internet Routing Daemon)
Network environment (including VPN tunnel) Chunghwa Telecom PPPoe non-fixed IP 100/40M
To TANet&rsquo;s WireGuard Tunnel
To GCP&rsquo;s WireGuard Tunnel"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.steveyi.net/en/posts/bgp-asn-specify-gateway/"><meta property="og:image" content="https://blog.steveyi.net/images/banner.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-06T02:13:10+08:00"><meta property="article:modified_time" content="2021-02-06T02:13:10+08:00"><meta property="og:site_name" content="SteveYi's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.steveyi.net/images/banner.webp"><meta name=twitter:title content="Designating network egress by AS Number"><meta name=twitter:description content="In January of last year, I applied for my first ASN - AS209557, and did a lot of cool experiments!
Today, I reconfigured my home router and can now designate which route to take based on ASN.
First, let me introduce my router information Ubuntu 20.04 software router
Bird2 (Internet Routing Daemon)
Network environment (including VPN tunnel) Chunghwa Telecom PPPoe non-fixed IP 100/40M
To TANet&rsquo;s WireGuard Tunnel
To GCP&rsquo;s WireGuard Tunnel"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.steveyi.net/en/posts/"},{"@type":"ListItem","position":2,"name":"Designating network egress by AS Number","item":"https://blog.steveyi.net/en/posts/bgp-asn-specify-gateway/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Designating network egress by AS Number","name":"Designating network egress by AS Number","description":"In January of last year, I applied for my first ASN - AS209557, and did a lot of cool experiments!\nToday, I reconfigured my home router and can now designate which route to take based on ASN.\nFirst, let me introduce my router information Ubuntu 20.04 software router\nBird2 (Internet Routing Daemon)\nNetwork environment (including VPN tunnel) Chunghwa Telecom PPPoe non-fixed IP 100/40M\nTo TANet\u0026rsquo;s WireGuard Tunnel\nTo GCP\u0026rsquo;s WireGuard Tunnel","keywords":[],"articleBody":"In January of last year, I applied for my first ASN - AS209557, and did a lot of cool experiments!\nToday, I reconfigured my home router and can now designate which route to take based on ASN.\nFirst, let me introduce my router information Ubuntu 20.04 software router\nBird2 (Internet Routing Daemon)\nNetwork environment (including VPN tunnel) Chunghwa Telecom PPPoe non-fixed IP 100/40M\nTo TANet’s WireGuard Tunnel\nTo GCP’s WireGuard Tunnel\nTo Vultr’s WireGuard Tunnel\nThe main idea is to route AS1659 and AS6939 through TANet, AS60614 through Vultr, and the rest through Chunghwa Telecom, while enabling NAT for all. The entire home network is in a VRF (vrf_HOME). PS. The following article will be directly integrated into the Kernel.\nInstall bird2 First, we need to install bird2, which is a routing process software.\nIt can handle BGP, OSPF, ISIS, Static Route, and other routes.\nDebian \u0026 Ubuntu:\napt install bird2 CentOS:\nyum install bird2 BGP Configure After installing bird2, we need to use eBGP Multihop to collect a full table.\nIn theory, existing network providers will require you to have an IANA-approved ASN to peer.\nHowever, we can also use Private ASN for peering (if the other side allows it).\nI recommend using Vultr’s VPS to collect the full table, and you can refer to the article Use BIRD to Announcing IPv6 on Vultr for details.\nSince we are Multihop, we cannot reach the routes sent by the other side.\nSo we put the routes in the table.\nipv4 table global_v4; Next, since we want to write to VRF, we first create a filter policy.\nIf the ASN equals 60614, then the route is changed to 10.121.1.2. Others remain unchanged… and so on.\nfilter policy_routing { # TANet if bgp_path.last = 1659 then { gw = 10.121.208.254; accept; } # HE if bgp_path.last = 6939 then { gw = 10.121.208.254; accept; } # SteveYi Network Service if bgp_path.last = 60614 then { gw = 10.121.218.62; accept; } reject; } Final Since I adjusted the network again, currently only two routes are set up (:\nThe code is roughly like this, you can try it out.\nI feel like I can also make a cool thing to automatically set up eBGP multihop (#\nlog syslog all; router id 10.121.211.254; # debug protocols all; watchdog warning 5 s; watchdog timeout 30 s; ipv4 table global_v4; ipv4 table policy_v4; protocol device {} protocol direct { ipv4; } template bgp bgp_feeder { multihop; graceful restart on; ipv4 { table global_v4; import all; export none; }; } protocol bgp SteveYi_Feed from bgp_feeder { local as 209557; neighbor as 60614; neighbor xxx.xxx.xxx.xxx; } define steveyi_asn = [ 60614, 209557 ]; filter policy_routing { # SteveYi Network Service if bgp_path.last ~ steveyi_asn then { gw = 10.121.217.11; accept; } # HE if bgp_path.last = 6939 then { gw = 10.121.218.62; accept; } reject; } # Prevent Feed from being eaten by BGP protocol static { ipv4; route 10.120.0.0/14 via 10.121.208.254; } protocol kernel { scan time 20; ipv4 { table global_v4; import none; export filter policy_routing; }; } Reference articles \u0026 assisting partners Thanks to James Swineson’s BGP at Home (1.5): My Dual-Line Traffic Splitting Rules\nThanks to 奈特 for providing bird2 usage assistance and tips\nThanks to Licson, Nato Laboratory, James Swineson for providing BGP Full Table\n","wordCount":"552","inLanguage":"en","datePublished":"2021-02-06T02:13:10+08:00","dateModified":"2021-02-06T02:13:10+08:00","author":{"@type":"Person","name":"SteveYi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.steveyi.net/en/posts/bgp-asn-specify-gateway/"},"publisher":{"@type":"Organization","name":"SteveYi's Blog","logo":{"@type":"ImageObject","url":"https://blog.steveyi.net/images/me.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.steveyi.net/en/ accesskey=h title="SteveYi's Blog (Alt + H)">SteveYi's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.steveyi.net/ title=正體中文 aria-label=正體中文>Tw</a></li></ul></div></div><ul id=menu><li><a href=https://blog.steveyi.net/en/ title=首頁><span>首頁</span></a></li><li><a href=https://blog.steveyi.net/en/posts/ title=文章列表><span>文章列表</span></a></li><li><a href=https://blog.steveyi.net/en/about/ title=關於小易><span>關於小易</span></a></li><li><a href=https://twitter.com/steveyiyo title=Twitter><span>Twitter</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Designating network egress by AS Number</h1><div class=post-meta><span title='2021-02-06 02:13:10 +0800 +0800'>February 6, 2021</span>&nbsp;·&nbsp;SteveYi&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://blog.steveyi.net/posts/bgp-asn-specify-gateway/>Tw</a></li></ul></div></header><div class=post-content><p>In January of last year, I applied for my first ASN - <a href=https://whois.steveyi.net/whois/AS209557>AS209557</a>, and did a lot of cool experiments!</p><p>Today, I reconfigured my home router and can now designate which route to take based on ASN.</p><h3 id=first-let-me-introduce-my-router-information>First, let me introduce my router information<a hidden class=anchor aria-hidden=true href=#first-let-me-introduce-my-router-information>#</a></h3><p>Ubuntu 20.04 software router<br>Bird2 (Internet Routing Daemon)<br><img loading=lazy src=https://i.imgur.com/iKW3r01.png alt></p><h3 id=network-environment-including-vpn-tunnel>Network environment (including VPN tunnel)<a hidden class=anchor aria-hidden=true href=#network-environment-including-vpn-tunnel>#</a></h3><p>Chunghwa Telecom PPPoe non-fixed IP 100/40M<br>To TANet&rsquo;s <a href=https://wireguard.com/>WireGuard</a> Tunnel<br>To GCP&rsquo;s <a href=https://wireguard.com/>WireGuard</a> Tunnel<br>To Vultr&rsquo;s <a href=https://wireguard.com/>WireGuard</a> Tunnel</p><p>The main idea is to route AS1659 and AS6939 through TANet, AS60614 through Vultr, and the rest through Chunghwa Telecom, while enabling NAT for all. The entire home network is in a VRF (vrf_HOME). PS. The following article will be directly integrated into the Kernel.</p><h3 id=install-bird2>Install bird2<a hidden class=anchor aria-hidden=true href=#install-bird2>#</a></h3><p>First, we need to install bird2, which is a routing process software.<br>It can handle BGP, OSPF, ISIS, Static Route, and other routes.</p><p>Debian & Ubuntu:</p><pre tabindex=0><code>apt install bird2
</code></pre><p>CentOS:</p><pre tabindex=0><code>yum install bird2
</code></pre><h3 id=bgp-configure>BGP Configure<a hidden class=anchor aria-hidden=true href=#bgp-configure>#</a></h3><p>After installing bird2, we need to use eBGP Multihop to collect a full table.<br>In theory, existing network providers will require you to have an IANA-approved ASN to peer.</p><p>However, we can also use Private ASN for peering (if the other side allows it).<br>I recommend using Vultr&rsquo;s VPS to collect the full table, and you can refer to the article <a href=https://blog.steveyi.net/posts/use-bird6-broadcast-ipv6-vultr/>Use BIRD to Announcing IPv6 on Vultr</a> for details.</p><p>Since we are Multihop, we cannot reach the routes sent by the other side.<br>So we put the routes in the table.</p><pre tabindex=0><code>ipv4 table global_v4;
</code></pre><p>Next, since we want to write to VRF, we first create a filter policy.<br>If the ASN equals 60614, then the route is changed to 10.121.1.2. Others remain unchanged&mldr; and so on.</p><pre tabindex=0><code>filter policy_routing {

        # TANet
        if bgp_path.last = 1659 then {
            gw = 10.121.208.254;
            accept;
        }

        # HE
        if bgp_path.last = 6939 then {
            gw = 10.121.208.254;
            accept;
        }
 
        # SteveYi Network Service
        if bgp_path.last = 60614 then {
            gw = 10.121.218.62;
            accept;
        }

        reject;
}
</code></pre><h3 id=final>Final<a hidden class=anchor aria-hidden=true href=#final>#</a></h3><p>Since I adjusted the network again, currently only two routes are set up (:</p><p><img loading=lazy src=https://i.imgur.com/mgyCzFl.png alt></p><p>The code is roughly like this, you can try it out.<br>I feel like I can also make a cool thing to automatically set up eBGP multihop (#</p><pre tabindex=0><code>log syslog all;
router id 10.121.211.254;
# debug protocols all;
watchdog warning 5 s;
watchdog timeout 30 s;
ipv4 table global_v4;
ipv4 table policy_v4;
protocol device {}
protocol direct { ipv4; }
 
template bgp bgp_feeder {
    multihop;
    graceful restart on;
    ipv4 {
        table global_v4;
        import all;
        export none;
    };
}
 
protocol bgp SteveYi_Feed from bgp_feeder {
	local as 209557;
    neighbor as 60614;
    neighbor xxx.xxx.xxx.xxx;
}

define steveyi_asn = [
        60614,
        209557
];

filter policy_routing {
    # SteveYi Network Service
    if bgp_path.last ~ steveyi_asn then {
        gw = 10.121.217.11;
        accept;
    }

    # HE
    if bgp_path.last = 6939 then {
        gw = 10.121.218.62;
        accept;
    }

    reject;
}

# Prevent Feed from being eaten by BGP
protocol static
{
    ipv4;
	route 10.120.0.0/14 via 10.121.208.254;
}

protocol kernel
{
    scan time 20;
    ipv4 {
        table global_v4;
        import none;
        export filter policy_routing;
    };
}
</code></pre><h3 id=reference-articles--assisting-partners>Reference articles & assisting partners<a hidden class=anchor aria-hidden=true href=#reference-articles--assisting-partners>#</a></h3><p>Thanks to <a href=https://swineson.me/>James Swineson</a>&rsquo;s <a href=https://blog.swineson.me/zh/bgp-at-home-1-5-my-filter-rules/>BGP at Home (1.5): My Dual-Line Traffic Splitting Rules</a><br>Thanks to <a href=https://who.nat.moe/>奈特</a> for providing bird2 usage assistance and tips<br>Thanks to <a href=https://licson.net/>Licson</a>, <a href=https://internet.nat.moe/>Nato Laboratory</a>, <a href=https://swineson.me/>James Swineson</a> for providing BGP Full Table</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.steveyi.net/en/>SteveYi's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>