<!doctype html><html lang=tw dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>利用 FRRouting 設定策略路由 | 小易的部落格</title><meta name=keywords content><meta name=description content="前幾天，我為了調整我實驗室內的網路架構，讓其可以全部走 VPN 出去，並且可以進入到我的大內網，所以在研究策略路由 (PBR)
我本來是使用 VRF（三層交換）來隔離我的網路（其實這樣應該算另類的策略路由了吧X），但這樣會導致我沒辦法把我的 Service 監聽在 VRF Interface 內。
導致&mldr; 我就不能架設 DoH 在路由器上了
後來，我發現我可以利用其他方式做到 PBR，而不需要透過 VRF 來隔離
PBR 是什麼？ PBR 全名 Policy Based Routing，是一種可以透過修改下一跳 IP Address 來達到控制路由或封包方向的一種技術
在 Linux 下怎麼做到？ Linux 下其實有許多種方式可以做到，比如說透過 Routing Daemon 或是 ip link 及 ip rule 的指令去做到
# 比如說我想要讓 10.121.210.0/24 這條路由放在一張表裡面 ip rule add from 10.121.210.0/24 lookup TW # 並讓其網路走 VPN Interface 出去 ip route add 0.0.0.0/0 via 10.121.210.0/24 dev VPN-JP table TW 但這樣的話，我每次都開機時都要執行一次 Script。"><meta name=author content="SteveYi"><link rel=canonical href=https://blog.steveyi.net/posts/frrouting-pbr/><link crossorigin=anonymous href=/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.steveyi.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.steveyi.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.steveyi.net/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.steveyi.net/apple-touch-icon.png><link rel=mask-icon href=https://blog.steveyi.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=tw href=https://blog.steveyi.net/posts/frrouting-pbr/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-CPGWT2M3VT"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CPGWT2M3VT",{anonymize_ip:!1})}</script><meta property="og:title" content="利用 FRRouting 設定策略路由"><meta property="og:description" content="前幾天，我為了調整我實驗室內的網路架構，讓其可以全部走 VPN 出去，並且可以進入到我的大內網，所以在研究策略路由 (PBR)
我本來是使用 VRF（三層交換）來隔離我的網路（其實這樣應該算另類的策略路由了吧X），但這樣會導致我沒辦法把我的 Service 監聽在 VRF Interface 內。
導致&mldr; 我就不能架設 DoH 在路由器上了
後來，我發現我可以利用其他方式做到 PBR，而不需要透過 VRF 來隔離
PBR 是什麼？ PBR 全名 Policy Based Routing，是一種可以透過修改下一跳 IP Address 來達到控制路由或封包方向的一種技術
在 Linux 下怎麼做到？ Linux 下其實有許多種方式可以做到，比如說透過 Routing Daemon 或是 ip link 及 ip rule 的指令去做到
# 比如說我想要讓 10.121.210.0/24 這條路由放在一張表裡面 ip rule add from 10.121.210.0/24 lookup TW # 並讓其網路走 VPN Interface 出去 ip route add 0.0.0.0/0 via 10.121.210.0/24 dev VPN-JP table TW 但這樣的話，我每次都開機時都要執行一次 Script。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.steveyi.net/posts/frrouting-pbr/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-18T16:23:58+08:00"><meta property="article:modified_time" content="2021-05-18T16:23:58+08:00"><meta property="og:site_name" content="小易的部落格"><meta name=twitter:card content="summary"><meta name=twitter:title content="利用 FRRouting 設定策略路由"><meta name=twitter:description content="前幾天，我為了調整我實驗室內的網路架構，讓其可以全部走 VPN 出去，並且可以進入到我的大內網，所以在研究策略路由 (PBR)
我本來是使用 VRF（三層交換）來隔離我的網路（其實這樣應該算另類的策略路由了吧X），但這樣會導致我沒辦法把我的 Service 監聽在 VRF Interface 內。
導致&mldr; 我就不能架設 DoH 在路由器上了
後來，我發現我可以利用其他方式做到 PBR，而不需要透過 VRF 來隔離
PBR 是什麼？ PBR 全名 Policy Based Routing，是一種可以透過修改下一跳 IP Address 來達到控制路由或封包方向的一種技術
在 Linux 下怎麼做到？ Linux 下其實有許多種方式可以做到，比如說透過 Routing Daemon 或是 ip link 及 ip rule 的指令去做到
# 比如說我想要讓 10.121.210.0/24 這條路由放在一張表裡面 ip rule add from 10.121.210.0/24 lookup TW # 並讓其網路走 VPN Interface 出去 ip route add 0.0.0.0/0 via 10.121.210.0/24 dev VPN-JP table TW 但這樣的話，我每次都開機時都要執行一次 Script。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.steveyi.net/posts/"},{"@type":"ListItem","position":2,"name":"利用 FRRouting 設定策略路由","item":"https://blog.steveyi.net/posts/frrouting-pbr/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"利用 FRRouting 設定策略路由","name":"利用 FRRouting 設定策略路由","description":"前幾天，我為了調整我實驗室內的網路架構，讓其可以全部走 VPN 出去，並且可以進入到我的大內網，所以在研究策略路由 (PBR)\n我本來是使用 VRF（三層交換）來隔離我的網路（其實這樣應該算另類的策略路由了吧X），但這樣會導致我沒辦法把我的 Service 監聽在 VRF Interface 內。\n導致\u0026hellip; 我就不能架設 DoH 在路由器上了\n後來，我發現我可以利用其他方式做到 PBR，而不需要透過 VRF 來隔離\nPBR 是什麼？ PBR 全名 Policy Based Routing，是一種可以透過修改下一跳 IP Address 來達到控制路由或封包方向的一種技術\n在 Linux 下怎麼做到？ Linux 下其實有許多種方式可以做到，比如說透過 Routing Daemon 或是 ip link 及 ip rule 的指令去做到\n# 比如說我想要讓 10.121.210.0/24 這條路由放在一張表裡面 ip rule add from 10.121.210.0/24 lookup TW # 並讓其網路走 VPN Interface 出去 ip route add 0.0.0.0/0 via 10.121.210.0/24 dev VPN-JP table TW 但這樣的話，我每次都開機時都要執行一次 Script。","keywords":[],"articleBody":"前幾天，我為了調整我實驗室內的網路架構，讓其可以全部走 VPN 出去，並且可以進入到我的大內網，所以在研究策略路由 (PBR)\n我本來是使用 VRF（三層交換）來隔離我的網路（其實這樣應該算另類的策略路由了吧X），但這樣會導致我沒辦法把我的 Service 監聽在 VRF Interface 內。\n導致… 我就不能架設 DoH 在路由器上了\n後來，我發現我可以利用其他方式做到 PBR，而不需要透過 VRF 來隔離\nPBR 是什麼？ PBR 全名 Policy Based Routing，是一種可以透過修改下一跳 IP Address 來達到控制路由或封包方向的一種技術\n在 Linux 下怎麼做到？ Linux 下其實有許多種方式可以做到，比如說透過 Routing Daemon 或是 ip link 及 ip rule 的指令去做到\n# 比如說我想要讓 10.121.210.0/24 這條路由放在一張表裡面 ip rule add from 10.121.210.0/24 lookup TW # 並讓其網路走 VPN Interface 出去 ip route add 0.0.0.0/0 via 10.121.210.0/24 dev VPN-JP table TW 但這樣的話，我每次都開機時都要執行一次 Script。\n但我又不想要透過 Script 去設定 PBR\n於是我查詢了一下 FRRouting 這套路由套件有沒有相關功能，沒想到真的有設計 PBR 的功能！\n仔細看完 官方文件 後，我們就馬上來實作啦！\n在此之前，若還沒有安裝 FRRouting 的話，可以參考 這篇文章 來進行安裝唷～\n設定 PBR 那目前，我們的需求是這樣\n# VPN 隧道 IP Address: 10.121.99.0/31 Gateway: 10.121.99.1/31 # 大內網 Route: 10.120.0.0/14 Gateway: 10.121.208.254 # 用於伺服器內的機器及實體電腦 10.121.210.0/24 # 需求 Default Route 發往 VPN 對端，並設定 SNAT 所以我們可以輸入這些指令，來新增規則\ninterface PBR Policy nexthop-group \u003c自定義名稱\u003e\nnexthop \u003c下一跳，理論上是 VPN 對端\u003e pbr-map \u003c自定義名稱\u003e seq \u003c優先程度\u003e\nmatch \u003c來源 IP 或是目的地 IP\u003e set nexthop-group \u003c上面定義的名稱\u003e # 如果 match 的話，則就綁定上我們剛剛建立的規則 interface ens19 pbr-policy VPN ! interface tun1 pbr-policy VPN ! nexthop-group JP nexthop 103.156.184.1 ! nexthop-group STUIN nexthop 10.121.208.254 ! pbr-map VPN seq 5 match dst-ip 10.120.0.0/14 set nexthop-group STUIN ! pbr-map VPN seq 10 match src-ip 10.121.210.0/24 set nexthop-group JP ! 最終，我們可以輸入指令 show pbr nexthop-groups，來查看目前的規則！\n","wordCount":"189","inLanguage":"tw","datePublished":"2021-05-18T16:23:58+08:00","dateModified":"2021-05-18T16:23:58+08:00","author":{"@type":"Person","name":"SteveYi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.steveyi.net/posts/frrouting-pbr/"},"publisher":{"@type":"Organization","name":"小易的部落格","logo":{"@type":"ImageObject","url":"https://blog.steveyi.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.steveyi.net/ accesskey=h title="小易的部落格 (Alt + H)">小易的部落格</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.steveyi.net/en/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=https://blog.steveyi.net/ title=首頁><span>首頁</span></a></li><li><a href=https://blog.steveyi.net/posts/ title=文章列表><span>文章列表</span></a></li><li><a href=https://blog.steveyi.net/about/ title=關於小易><span>關於小易</span></a></li><li><a href=https://twitter.com/steveyiyo title=Twitter><span>Twitter</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>利用 FRRouting 設定策略路由</h1><div class=post-meta><span title='2021-05-18 16:23:58 +0800 +0800'>2021-05-18</span>&nbsp;·&nbsp;SteveYi</div></header><div class=post-content><p>前幾天，我為了調整我實驗室內的網路架構，讓其可以全部走 VPN 出去，並且可以進入到我的大內網，所以在研究策略路由 (PBR)</p><p>我本來是使用 VRF（三層交換）來隔離我的網路（其實這樣應該算另類的策略路由了吧X），但這樣會導致我沒辦法把我的 Service 監聽在 VRF Interface 內。</p><p>導致&mldr; 我就不能架設 DoH 在路由器上了</p><p>後來，我發現我可以利用其他方式做到 PBR，而不需要透過 VRF 來隔離</p><h2 id=pbr-是什麼>PBR 是什麼？<a hidden class=anchor aria-hidden=true href=#pbr-是什麼>#</a></h2><p>PBR 全名 Policy Based Routing，是一種可以透過修改下一跳 IP Address 來達到控制路由或封包方向的一種技術</p><h2 id=在-linux-下怎麼做到>在 Linux 下怎麼做到？<a hidden class=anchor aria-hidden=true href=#在-linux-下怎麼做到>#</a></h2><p>Linux 下其實有許多種方式可以做到，比如說透過 Routing Daemon 或是 <code>ip link</code> 及 <code>ip rule</code> 的指令去做到</p><pre tabindex=0><code># 比如說我想要讓 10.121.210.0/24 這條路由放在一張表裡面
ip rule add from 10.121.210.0/24 lookup TW

# 並讓其網路走 VPN Interface 出去
ip route add 0.0.0.0/0 via 10.121.210.0/24 dev VPN-JP table TW
</code></pre><p>但這樣的話，我每次都開機時都要執行一次 Script。</p><p>但我又不想要透過 Script 去設定 PBR</p><p><img loading=lazy src=https://static-a1.steveyi.net/media/blog/1621326935.png alt></p><p>於是我查詢了一下 <a href=https://frrouting.org/>FRRouting</a> 這套路由套件有沒有相關功能，沒想到真的有設計 PBR 的功能！</p><p>仔細看完 <a href=https://docs.frrouting.org/en/latest/pbr.html>官方文件</a> 後，我們就馬上來實作啦！</p><p>在此之前，若還沒有安裝 FRRouting 的話，可以參考 <a href=https://blog.steveyi.net/frrouting-install/>這篇文章</a> 來進行安裝唷～</p><h2 id=設定-pbr>設定 PBR<a hidden class=anchor aria-hidden=true href=#設定-pbr>#</a></h2><p>那目前，我們的需求是這樣</p><pre tabindex=0><code># VPN 隧道
IP Address: 10.121.99.0/31
Gateway: 10.121.99.1/31

# 大內網
Route: 10.120.0.0/14
Gateway: 10.121.208.254

# 用於伺服器內的機器及實體電腦
10.121.210.0/24

# 需求
Default Route 發往 VPN 對端，並設定 SNAT
</code></pre><p>所以我們可以輸入這些指令，來新增規則</p><ul><li><p>interface &lt;interface_name></p><ul><li>PBR Policy</li></ul></li><li><p>nexthop-group &lt;自定義名稱></p><ul><li>nexthop &lt;下一跳，理論上是 VPN 對端></li></ul></li><li><p>pbr-map &lt;自定義名稱> seq &lt;優先程度></p><ul><li>match &lt;來源 IP 或是目的地 IP></li><li>set nexthop-group &lt;上面定義的名稱></li><li><code># 如果 match 的話，則就綁定上我們剛剛建立的規則</code></li></ul></li></ul><pre tabindex=0><code>interface ens19
 pbr-policy VPN
!
interface tun1
 pbr-policy VPN
!
nexthop-group JP
 nexthop 103.156.184.1
!
nexthop-group STUIN
 nexthop 10.121.208.254
!
pbr-map VPN seq 5
 match dst-ip 10.120.0.0/14
 set nexthop-group STUIN
!
pbr-map VPN seq 10
 match src-ip 10.121.210.0/24
 set nexthop-group JP
!
</code></pre><p>最終，我們可以輸入指令 <code>show pbr nexthop-groups</code>，來查看目前的規則！</p><p><img loading=lazy src=https://static-a1.steveyi.net/media/blog/1621331786.png alt></p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.steveyi.net/>小易的部落格</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>