<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Network on 小易的部落格</title><link>http://127.0.0.1:8000/tags/network/</link><description>小易的部落格 (Network)</description><generator>Hugo -- gohugo.io</generator><language>tw</language><lastBuildDate>Mon, 08 Mar 2021 13:20:00 +0800</lastBuildDate><atom:link href="http://127.0.0.1:8000/tags/network/index.xml" rel="self" type="application/rss+xml"/><item><title>在 iptables 上設定 NAT</title><link>http://127.0.0.1:8000/posts/iptables_nat/</link><pubDate>Mon, 08 Mar 2021 13:20:00 +0800</pubDate><guid>http://127.0.0.1:8000/posts/iptables_nat/</guid><description>&lt;p>不久之前，小易將家裡的一台電腦裝上了 Ubuntu 20.04，並把它當成了軟路由在使用。&lt;/p>
&lt;p>但小易發現了一件事情，就是電腦沒辦法上網RRR！&lt;/p>
&lt;p>我們透過 mtr 追蹤路由後發現&amp;hellip;&lt;br>
路由送到 Gateway 就出不去了，於是我們在路由器上抓包發現&lt;br>
我們的內部 IP 發給 ISP 了。但沒有回程。&lt;/p>
&lt;p>如果 ISP 沒有設定好的話，就容易導致 IP Spoofing。&lt;/p>
&lt;p>所以我們必須要在這邊設定好封包轉換(NAT)，才可以上網！&lt;/p>
&lt;p>在 iptables 上的指令為這樣（注意：eth1 是公網網卡名稱）&lt;/p>
&lt;pre tabindex="0">&lt;code>iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE
&lt;/code>&lt;/pre>&lt;p>另外，如果只想允許某段網段轉換為 NAT，則可以寫成&lt;/p>
&lt;pre tabindex="0">&lt;code>iptables -t nat -A POSTROUTING -s 10.121.210.0/24 -o eth1 -j MASQUERADE
&lt;/code>&lt;/pre></description></item><item><title>成為 MANRS 參與者！</title><link>http://127.0.0.1:8000/posts/join-manrs-as-participants/</link><pubDate>Mon, 25 Jan 2021 00:03:31 +0800</pubDate><guid>http://127.0.0.1:8000/posts/join-manrs-as-participants/</guid><description>&lt;p>在去年年底時，我送出了 &lt;a href="https://network.steveyi.net/">SteveYi Network Service&lt;/a> 的 &lt;a href="https://www.manrs.org/">MANRS&lt;/a> 申請&lt;br>
今年年初時，我們通過了審核。正式成為 MANRS 的參與者！&lt;br>
我們的會員介紹在這裏 &lt;a href="https://www.manrs.org/isps/participants/entry/1484/">https://www.manrs.org/isps/participants/entry/1484/&lt;/a>&lt;br>
那麼，我們就順便來說說 我們如何實施 MANRS 政策&lt;/p>
&lt;p>MANRS 主要有四個政策，分別是這些&lt;/p>
&lt;blockquote>
&lt;p>避免廣播錯誤的路由&lt;br>
阻止錯誤偽造的IP流量&lt;br>
促進網絡運營商之間的溝通與協調&lt;br>
促進驗證在網際網路內的路由訊息&lt;/p>
&lt;/blockquote>
&lt;p>那我們是如何做到這些呢？&lt;/p>
&lt;blockquote>
&lt;p>首先，我們在我們的核心路由器上阻斷了 &lt;a href="https://tools.ietf.org/html/rfc1918/">RFC1918&lt;/a> 定義的私網 IP 位置流量，來自這些 &lt;strong>IP位置&lt;/strong> 的流量並不會往公網發送&lt;br>
其次，我們遵守 &lt;a href="https://tools.ietf.org/html/rfc8212/">RFC 8212&lt;/a>，在沒有明確的路由策略下，我們 &lt;strong>不會廣播沒有使用的網段&lt;/strong>。&lt;br>
並且，我們會從我們的 &lt;a href="https://www.radb.net/query?keywords=AS-STEVEYI">AS-STEVEYI&lt;/a> 中產生對應的 IRR 紀錄，並過濾掉 &lt;strong>不屬於我們的路由&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://i.imgur.com/3YMIHgZ.png" alt="">&lt;/p>
&lt;p>我們也會過濾與我們建立私人對等的對等方路由，我們會將所有對等方的 AS-SET 或 ASN 加進我們的 &lt;a href="https://www.radb.net/query?keywords=AS-STEVEYI-A">AS-STEVEYI-A&lt;/a> 中，並自動產生對應的 IRR 紀錄，過濾無效的路由&lt;/p>
&lt;p>我們也歡迎對我們的過濾系統有興趣的網路愛好者/工程師，可以發信至 info_at_steveyi_dot_net 與我們聯繫！&lt;/p></description></item><item><title>透過 BGP 與朋友組成內網</title><link>http://127.0.0.1:8000/posts/make-internal-network-by-bgp/</link><pubDate>Sun, 24 Jan 2021 02:00:00 +0000</pubDate><guid>http://127.0.0.1:8000/posts/make-internal-network-by-bgp/</guid><description>&lt;p>嗨！好久不見！&lt;/p>
&lt;p>在 2020 初時，我拿到了第一個 ASN號碼 - &lt;a href="https://bgp.he.net/AS209557/">AS209557&lt;/a>&lt;/p>
&lt;p>我也使用了 &lt;a href="https://tools.ietf.org/html/rfc1918">RFC 1918&lt;/a> 所定義的 IP Address ，與我一些朋友透過 BGP 及 Internet 隧道 組成了一個大內網&lt;/p>
&lt;p>那麼，讓我們開始吧！&lt;/p>
&lt;p>首先，我們使用 Ubuntu 20.04 來建立隧道，並與其他人建立 BGP 對等&lt;/p>
&lt;p>那通常，我都是使用 GRE, SIT 或是 WireGuard&lt;/p>
&lt;p>其中，GRE 或 SIT 隧道是屬於非加密隧道，在公網上是可以查看到其封包的。若要加密需要配上 IPsec&lt;/p>
&lt;p>WireGuard 則是在 2019 年 9 月 推出的點對點隧道，在 2020 年 3 月 已列入 Linux 內核&lt;/p>
&lt;p>（其實更早就在 Beta 了，但小易用 WireGuard 時已經是屬於穩定版了）&lt;/p>
&lt;p>那接著，是我與我朋友的對等信息&lt;/p>
&lt;p>PS. 部分 IP Address 被基於安全因素，可能與實際使用的 IP Address 不同&lt;/p>
&lt;p>我的資料&lt;/p>
&lt;pre tabindex="0">&lt;code>公網 IP Address: 59.126.1.1
隧道內 IP Address: 10.0.0.1/30
&lt;/code>&lt;/pre>&lt;p>對方資料&lt;/p>
&lt;pre tabindex="0">&lt;code>公網 IP Address: 140.113.1.1
隧道內 IP Address: 10.0.0.2/30
&lt;/code>&lt;/pre>&lt;p>建立完隧道之後，我們嘗試 ICMP PING 看看&lt;/p>
&lt;pre tabindex="0">&lt;code>root@tw-stuin:~# ping 10.0.0.2
PING 10.0.0.2 (10.0.0.2) 56(84) bytes of data.
64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=3.26 ms
64 bytes from 10.0.0.2: icmp_seq=2 ttl=64 time=3.22 ms
64 bytes from 10.0.0.2: icmp_seq=3 ttl=64 time=3.24 ms
--- 10.0.0.2 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 3.223/3.242/3.259/0.014 ms
&lt;/code>&lt;/pre>&lt;p>好，看起來通了！&lt;/p>
&lt;p>那接著，透過 BGP 協議來組建大內網了！&lt;/p>
&lt;p>首先，我們必須要在 Linux 上安裝一個 BGP Routing Daemon&lt;/p>
&lt;p>在 Linux 系統上，大部分人都使用 &lt;a href="https://bird.network.cz/">BIRD&lt;/a> 或是 &lt;a href="https://frrouting.org/">FRRouting&lt;/a>&lt;/p>
&lt;p>BIRD 比較類似於寫程式的概念(? FRRouting 則是類似於 Cisco 的概念(?&lt;/p>
&lt;p>至少我是這樣認為的，但本篇是使用 FRRouting 來進行操作&lt;/p>
&lt;p>首先，我們可以先參考 &lt;a href="https://blog.steveyi.net/frrouting-install/">這篇文章&lt;/a> 來安裝 FRRouting&lt;/p>
&lt;p>安裝完成之後，我們進入 Cli&lt;/p>
&lt;pre tabindex="0">&lt;code>vtysh
&lt;/code>&lt;/pre>&lt;p>接著，我們輸入以下指令，來開通 BGP 功能 PS. 如果沒有公網 ASN，可以使用 Private ASN 可參考 &lt;a href="https://tools.ietf.org/html/rfc6996">RFC 6996&lt;/a>&lt;/p>
&lt;pre tabindex="0">&lt;code>router bgp 你的ASN
&lt;/code>&lt;/pre>&lt;p>再來，我們輸入對等方資訊&lt;/p>
&lt;pre tabindex="0">&lt;code>neighbor 10.0.0.2 remote-as 對面的ASN
&lt;/code>&lt;/pre>&lt;p>由於是 IPv4 Peer，所以我們需要到 address-family ipv4 來進行設定。以此類推，如果設定 IPv6 的話，則是 address-family ipv6&lt;/p>
&lt;pre tabindex="0">&lt;code>address-family ipv4
&lt;/code>&lt;/pre>&lt;p>接著，我們可以發我們家的內部路由給對面。注意！不要將不屬於自己的路由隨便發給他，否則可能會造成 &lt;a href="https://www.cloudflare.com/en/learning/security/glossary/bgp-hijacking/">BGP hijacking&lt;/a>&lt;/p>
&lt;p>這邊發 10.10.1.0/24 及 192.168.99.0/24 這條路由給對方&lt;/p>
&lt;pre tabindex="0">&lt;code>network 10.10.1.0/24
network 192.168.99.0/24
&lt;/code>&lt;/pre>&lt;p>這邊也建議與對方先溝通好預計會廣播的路由，讓對方可以配好 filter，防止雙方有一方配錯&lt;/p>
&lt;p>後記：&lt;/p>
&lt;p>理論上大概這樣就可以通了！但要特別注意的是，在 ping 對方的時候，記得加上 Source IP Address!! 因為對方可能不會收隧道 IP Address&lt;/p>
&lt;p>但 FRRouting 在 7.5 版時，加入了 &lt;a href="https://tools.ietf.org/html/rfc8212">RFC 8212&lt;/a>&lt;/p>
&lt;p>若沒有明確的路由策略，則不會將路由寫入系統路由表中，也不會發路由給對方&lt;/p></description></item></channel></rss>